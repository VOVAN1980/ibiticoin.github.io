<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IBITIcoin — Подключение кошелька</title>
  <style>
    body {
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }
    h1 {
      margin-bottom: 20px;
      font-size: 24px;
    }
    button {
      margin: 5px 0;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background: #222;
      color: #ffd600;
      border: 2px solid #ffd600;
      border-radius: 4px;
    }
    button:hover {
      background: #333;
    }
    #address {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h1>Подключение кошелька IBITIcoin</h1>
  <button id="connectMetaMask">MetaMask</button>
  <button id="connectWCv2">WalletConnect v2</button>
  <p id="address">Адрес: <em>не подключён</em></p>

  <!-- -------------------------------------------------------------------
       Ниже — единственный <script type="module">. Копируйте «как есть».
       Он загрузит wagmi, ethers@6 и Web3Modal v2 через CDN (esm.sh).
       ------------------------------------------------------------------- -->
  <script type="module">
    import { configureChains, createClient } from 'https://esm.sh/wagmi@1.9.0';
    import { mainnet, bsc, goerli } from 'https://esm.sh/wagmi@1.9.0/chains';
    import { w3mConnectors, w3mProvider } from 'https://esm.sh/@web3modal/ethereum@2.8.2';
    import { Web3Modal, EthereumClient } from 'https://esm.sh/@walletconnect/web3modal@2.8.2';
    import { ethers } from 'https://esm.sh/ethers@6.6.1';

    // 1) Сюда вставьте ваш PROJECT_ID из walletconnect.com (v2-проект)
    const projectId = 'ВАШ_PROJECT_ID_ОТ_WALLETCONNECT';

    // 2) Список цепочек (здесь BSC, Ethereum Mainnet, тестовая Goerli — при необходимости удалите Goerli)
    const chains = [bsc, mainnet, goerli];

    // 3) Настраиваем провайдер через WalletConnect v2
    const { provider } = configureChains(chains, [
      w3mProvider({ projectId })
    ]);

    // 4) Создаём Wagmi-клиент (без авто-подключения)
    const wagmiClient = createClient({
      autoConnect: false,
      connectors: w3mConnectors({ chains, projectId }),
      provider
    });

    // 5) Инициализируем Web3Modal v2
    const ethereumClient = new EthereumClient(wagmiClient, chains);
    const web3Modal = new Web3Modal({
      projectId,
      theme: 'light',
      accentColor: 'default',
      ethereumClient
    });

    // 6) Глобальные переменные для провайдера и подписанта
    let providerGlobal = null;
    let signerGlobal   = null;
    let userAddress    = null;

    // 7) Функция колбэк — вызывается Web3Modal v2 после подключения
    window.onWalletConnected = (address, provider, signer) => {
      providerGlobal = provider;
      signerGlobal   = signer;
      userAddress    = address;
      document.getElementById('address').innerText = `Адрес: ${address}`;
    };

    // 8) Функция колбэк — отключение WC v2
    window.onWalletDisconnected = () => {
      providerGlobal = null;
      signerGlobal   = null;
      userAddress    = null;
      document.getElementById('address').innerText = 'Адрес: не подключён';
    };

    // 9) Подключиться через WalletConnect v2
    window.connectWithWalletConnectV2 = async () => {
      try {
        await web3Modal.open();
        const signer = await wagmiClient.getSigner();
        const address = await signer.getAddress();
        window.onWalletConnected(address, provider, signer);
      } catch (e) {
        console.error('Ошибка подключения WC v2:', e);
      }
    };

    // 10) Отключиться от WalletConnect v2
    window.disconnectWalletConnectV2 = async () => {
      try {
        await web3Modal.clearState();
        window.onWalletDisconnected();
      } catch (e) {
        console.error('Ошибка отключения WC v2:', e);
      }
    };

    // 11) Подключение через MetaMask (ethers v6)
    async function connectMetaMask() {
      if (!window.ethereum) {
        alert('MetaMask не установлен');
        return;
      }
      try {
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        providerGlobal = new ethers.Web3Provider(window.ethereum);
        signerGlobal   = providerGlobal.getSigner();
        userAddress    = await signerGlobal.getAddress();
        document.getElementById('address').innerText = `Адрес: ${userAddress}`;

        // Слушаем смену аккаунта/сети
        window.ethereum.on('accountsChanged', (accounts) => {
          if (accounts.length === 0) {
            window.onWalletDisconnected();
          } else {
            userAddress = accounts[0];
            document.getElementById('address').innerText = `Адрес: ${userAddress}`;
          }
        });
        window.ethereum.on('chainChanged', (chainId) => {
          console.log('Сеть изменилась:', chainId);
        });
      } catch (e) {
        console.error('MetaMask: не удалось подключиться', e);
      }
    }

    // 12) Повесим обработчики на кнопки
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('connectMetaMask').addEventListener('click', async () => {
        // Сбрасываем WC v2, если он был
        if (typeof window.disconnectWalletConnectV2 === 'function') {
          await window.disconnectWalletConnectV2();
        }
        await connectMetaMask();
      });
      document.getElementById('connectWCv2').addEventListener('click', async () => {
        // Сбрасываем MetaMask-соединение, если было
        if (providerGlobal && providerGlobal.provider?.isMetaMask) {
          window.onWalletDisconnected();
        }
        if (typeof window.connectWithWalletConnectV2 === 'function') {
          await window.connectWithWalletConnectV2();
        }
      });
    });
  </script>
  <!-- ------------------------------------------------------------------- -->
</body>
</html>
