<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wallet v2 (скрытый фрейм)</title>
  <style>
    /* Страница в iframe всегда скрыта, так что стили можно минимизировать */
    html, body {
      margin: 0;
      padding: 0;
      background: transparent;
      color: #fff;
      font-family: Arial, sans-serif;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Здесь нет кнопок — всё управляется сообщениями от родителя -->
  <script type="module">
    // ==== 1) Импорты через CDN (esm.sh) для WalletConnect v2 + ethers 6 ====
    import { createClient, configureChains } from 'https://esm.sh/wagmi@1.9.0';
    import { mainnet, bsc } from 'https://esm.sh/wagmi@1.9.0/chains';
    import { w3mConnectors, w3mProvider } from 'https://esm.sh/@web3modal/ethereum@2.8.2';
    import { Web3Modal, EthereumClient } from 'https://esm.sh/@walletconnect/web3modal@2.8.2';
    import { ethers } from 'https://esm.sh/ethers@6.6.1';

    // ==== 2) Ваш Project ID из WalletConnect v2 ====
    const WC_PROJECT_ID = 'ВАШ_WALLETCONNECT_V2_PROJECT_ID';

    // ==== 3) Конфиг сетей (BSC + Mainnet, без Goerli) ====
    const chains = [bsc, mainnet];

    // ==== 4) Настройка провайдера wagmi через WalletConnect v2 ====
    const { provider } = configureChains(chains, [
      w3mProvider({ projectId: WC_PROJECT_ID })
    ]);

    const wagmiClient = createClient({
      autoConnect: false,
      connectors: w3mConnectors({ chains, projectId: WC_PROJECT_ID }),
      provider
    });

    const ethereumClient = new EthereumClient(wagmiClient, chains);
    const web3Modal = new Web3Modal({
      projectId: WC_PROJECT_ID,
      theme: 'light',
      accentColor: 'default',
      ethereumClient
    });

    // ==== 5) Глобальные переменные: провайдер, подписант, адрес ====
    let providerGlobal = null;
    let signerGlobal   = null;
    let userAddress    = null;

    // ==== 6) Отправка сообщения родителю ====
    function postToParent(data) {
      window.parent.postMessage(data, '*');
    }

    // ==== 7) Обработчик сообщений от родителя ====
    window.addEventListener('message', async (event) => {
      const msg = event.data;
      if (!msg || typeof msg !== 'object') return;

      switch (msg.type) {
        // Родитель сказал «подключись через WCv2»
        case 'connect-wcv2':
          await connectWithWCv2();
          break;

        // Родитель сказал «разорви соединение»
        case 'disconnect-v2':
          await disconnectWCv2();
          break;

        // (Если нужно) Родитель может прислать команду «купить»:
        // case 'buy':
        //   await handleBuy(msg.tokenId, msg.price);
        //   break;
      }
    });

    // ==== 8) Функция подключения через WalletConnect v2 ====
    async function connectWithWCv2() {
      try {
        await web3Modal.open(); 
        const signer = await wagmiClient.getSigner();
        const address = await signer.getAddress();
        providerGlobal = wagmiClient.provider;
        signerGlobal   = signer;
        userAddress    = address;
        postToParent({ type: 'connected', address: address });
      } catch (e) {
        console.error('Ошибка WCv2:', e);
        postToParent({ type: 'error', error: e.message || e.toString() });
      }
    }

    // ==== 9) Функция отключения WalletConnect v2 ====
    async function disconnectWCv2() {
      try {
        await web3Modal.clearState();
        providerGlobal = null;
        signerGlobal   = null;
        userAddress    = null;
        postToParent({ type: 'disconnected' });
      } catch (e) {
        console.error('Ошибка отключения WCv2:', e);
        postToParent({ type: 'error', error: e.message || e.toString() });
      }
    }

    // Если вам нужно реализовать «купить токен» прямо отсюда, можно добавить:
    // async function handleBuy(tokenId, priceWei) {
    //   if (!signerGlobal) {
    //     postToParent({ type: 'error', error: 'Кошелёк не подключён' });
    //     return;
    //   }
    //   try {
    //     const contractAddress = '0xВАШ_АДРЕС_КОНТРАКТА';
    //     const contractAbi = PhasedTokenSaleAbi; // при условии, что вы импортировали ABI
    //     const contract = new ethers.Contract(contractAddress, contractAbi, signerGlobal);
    //     const tx = await contract.purchaseCoinToken(tokenId, { value: priceWei });
    //     const receipt = await tx.wait();
    //     postToParent({ type: 'bought', txHash: receipt.transactionHash });
    //   } catch (err) {
    //     postToParent({ type: 'error', error: err.data?.message || err.message });
    //   }
    // }
  </script>
</body>
</html>
