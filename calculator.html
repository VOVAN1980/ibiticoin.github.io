<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IBITIcoin Calculator</title>

  <link rel="stylesheet" href="css/style.css" />

  <style>
    /* ===== Page layout ===== */
    body{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    .hero-header{
      margin-top:18px;
      padding:10px 0 6px;
      text-align:center;
    }
    .hero-header img{
      width:180px;
      display:block;
      margin:0 auto 10px;
    }
    .hero-header h1{
      font-size:2.05rem;
      margin:0;
      line-height:1.15;
    }
    .hero-header .sub{
      margin-top:6px;
      opacity:.85;
      font-size:.98rem;
    }

    .calculator-wrap{
      width:100%;
      display:flex;
      justify-content:center;
      padding:16px 14px 40px;
    }

    .card{
      width:min(560px, 100%);
      border:1px solid rgba(255,215,0,0.35);
      border-radius:16px;
      background:rgba(0,0,0,0.45);
      box-shadow:0 0 22px rgba(0,0,0,0.25);
      padding:16px;
    }

    .topgrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    @media (max-width:520px){
      .topgrid{ grid-template-columns:1fr; }
    }

    .pill{
      border:1px solid rgba(255,215,0,0.35);
      border-radius:999px;
      padding:8px 10px;
      font-size:.95rem;
      text-align:center;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .muted{
      opacity:.85;
      font-size:.95rem;
      line-height:1.35;
    }

    .formgrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width:520px){
      .formgrid{ grid-template-columns:1fr; }
    }

    label{
      display:block;
      margin:0 0 6px;
      min-height:18px; /* фикс “пляшущих” лейблов */
    }

    input, button{
      width:100%;
      padding:12px 14px;
      font-size:1rem;
      box-sizing:border-box;
      border-radius:10px;
      border:1px solid rgba(255,215,0,0.25);
      background:rgba(10,10,10,0.55);
      color:#fff;
      outline:none;
    }
    input::placeholder{ color:rgba(255,255,255,0.55); }

    .actions{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    @media (max-width:520px){
      .actions{ grid-template-columns:1fr; }
    }

    button{ cursor:pointer; }
    button:hover{ filter:brightness(1.08); }

    .result{
      margin-top:12px;
      font-weight:650;
      line-height:1.35;
      word-break:break-word;
      text-align:center;
      white-space:pre-line;
    }
    .ok{ color:#e8ffcf; }
    .error{ color:#ffb3b3; }

    footer{ margin-top:auto; }
  </style>
</head>

<body>
  <!-- Corner buttons (оставил твою структуру) -->
  <div class="corner-box corner-box-left">
    <a href="index.html" id="navHome">Home</a>
  </div>
  <div class="corner-box corner-box-right">
    <a href="roadmap.html" id="navRoadmap">Roadmap</a> |
    <a href="?lang=ru" id="navRU">RU</a> |
    <a href="?lang=en" id="navEN">EN</a>
  </div>

  <!-- Header -->
  <header class="hero-header">
    <img src="img/logo.png" alt="IBITIcoin Logo" />
    <h1 id="title">IBITIcoin Investment Calculator</h1>
    <div class="sub" id="subtitle">Live price from PancakeSwap (pair reserves)</div>
  </header>

  <!-- Calculator -->
  <main class="calculator-wrap">
    <div class="card">
      <div class="topgrid">
        <div class="pill" id="pricePill">Price: —</div>
        <div class="pill" id="updatedPill">Updated: —</div>
      </div>

      <div class="muted" id="reservesLine">Reserves: —</div>
      <div class="muted" style="margin-top:6px;" id="sourceLine">
        Source: IBITI/USDT on PancakeSwap v2 (spot)
      </div>

      <div class="formgrid">
        <div>
          <label for="usdInput" id="lblUsd">USD (USDT)</label>
          <input type="number" id="usdInput" placeholder="10" min="0" step="any" />
        </div>

        <div>
          <label for="ibitiInput" id="lblIbiti">IBITI</label>
          <input type="number" id="ibitiInput" placeholder="0" min="0" step="any" />
        </div>

        <div>
          <label for="slippage" id="lblSlip">Slippage buffer (%)</label>
          <input type="number" id="slippage" value="1" min="0" max="20" step="0.1" />
        </div>

        <div class="muted" style="align-self:end;" id="hint">
          Fill only one field (USD or IBITI). We’ll convert using live pool price.
        </div>
      </div>

      <div class="actions">
        <button id="btnCalc">Calculate</button>
        <button id="btnRefresh">Refresh</button>
        <button id="btnClear">Clear</button>
      </div>

      <div class="result" id="result"></div>
      <div class="muted" style="margin-top:10px;" id="note">
        Note: this is a spot estimate from reserves. Real swap depends on fee & price impact.
      </div>
      <div class="muted" style="margin-top:8px;" id="corsTip"></div>
    </div>
  </main>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 IBITIcoin. All rights reserved.</p>
    <p>
      <a href="privacy.html">Privacy Policy</a> |
      <a href="terms.html">Terms of Use</a>
    </p>
    <p>
      <a href="https://twitter.com/IBITIcoin" target="_blank">Twitter</a> |
      <a href="https://t.me/IBITIcoin_chat" target="_blank">Telegram</a> |
      <a href="https://instagram.com/IBITIcoin_official" target="_blank">Instagram</a> |
      <a href="https://facebook.com/IBITIcoin" target="_blank">Facebook</a>
    </p>
    <p><a href="mailto:info@ibiticoin.com">info@ibiticoin.com</a></p>
  </footer>

  <!-- ethers (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>

  <script>
    // =========================
    // CONFIG (BSC MAINNET)
    // =========================
    const CFG = {
      PAIR:  "0xADfb9F0f810311e9c01C27B380909A5FfC104Be0", // IBITI/USDT pair
      USDT:  "0x55d398326f99059fF775485246999027B3197955",
      IBITI: "0x47F2FFCb164b2EeCCfb7eC436Dfb3637a457B9bb",

      USDT_DECIMALS: 18,
      IBITI_DECIMALS: 8,

      // несколько RPC на выбор (часть может резаться CORS — поэтому список)
      RPC_URLS: [
        "https://bsc-rpc.publicnode.com",
        "https://rpc.ankr.com/bsc",
        "https://bsc-dataseed.binance.org/",
        "https://bsc-dataseed1.binance.org/",
        "https://bsc-dataseed2.binance.org/"
      ],

      AUTO_REFRESH_MS: 30000
    };

    const PAIR_ABI = [
      "function token0() view returns (address)",
      "function token1() view returns (address)",
      "function getReserves() view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)"
    ];

    // =========================
    // i18n RU/EN
    // =========================
    const I18N = {
      en: {
        title: "IBITIcoin Investment Calculator",
        subtitle: "Live price from PancakeSwap (pair reserves)",
        home: "Home",
        roadmap: "Roadmap",
        price: "Price",
        updated: "Updated",
        reserves: "Reserves",
        source: "Source: IBITI/USDT on PancakeSwap v2 (spot)",
        lblUsd: "USD (USDT)",
        lblIbiti: "IBITI",
        lblSlip: "Slippage buffer (%)",
        hint: "Fill only one field (USD or IBITI). We’ll convert using live pool price.",
        btnCalc: "Calculate",
        btnRefresh: "Refresh",
        btnClear: "Clear",
        note: "Note: this is a spot estimate from reserves. Real swap depends on fee & price impact.",
        errOneField: "Fill ONLY one field: USD or IBITI.",
        errNeedValue: "Enter a value in USD or IBITI.",
        working: "Calculating using live Pancake price…",
        refreshed: "Price refreshed.",
        fetchFail: "Could not fetch live price.",
        corsTip: "If you see CORS/RPC errors: easiest fix is a tiny proxy (Cloudflare Worker / Netlify Function) that fetches reserves server-side."
      },
      ru: {
        title: "Калькулятор инвестиций в IBITIcoin",
        subtitle: "Текущая цена с PancakeSwap (по резервам пары)",
        home: "Home",
        roadmap: "Roadmap",
        price: "Цена",
        updated: "Обновлено",
        reserves: "Резервы",
        source: "Источник: IBITI/USDT на PancakeSwap v2 (spot)",
        lblUsd: "USD (USDT)",
        lblIbiti: "IBITI",
        lblSlip: "Буфер проскальзывания (%)",
        hint: "Заполни только одно поле (USD или IBITI). Посчитаем по живой цене пула.",
        btnCalc: "Посчитать",
        btnRefresh: "Обновить",
        btnClear: "Очистить",
        note: "Примечание: это оценка по резервам (spot). Реальный свап зависит от комиссии и влияния на цену.",
        errOneField: "Заполни ТОЛЬКО одно поле: USD или IBITI.",
        errNeedValue: "Введи сумму в USD или IBITI.",
        working: "Считаю по текущей цене Pancake…",
        refreshed: "Цена обновлена.",
        fetchFail: "Не удалось получить живую цену.",
        corsTip: "Если вылезают CORS/RPC ошибки: самый простой фикс — мини-прокси (Cloudflare Worker / Netlify Function), который читает резервы на сервере."
      }
    };

    function $(id){ return document.getElementById(id); }

    function getLang(){
      const u = new URL(location.href);
      const v = (u.searchParams.get("lang") || "en").toLowerCase();
      return v === "ru" ? "ru" : "en";
    }

    const lang = getLang();
    const T = I18N[lang];

    function applyI18n(){
      document.documentElement.lang = lang;
      $("title").innerText = T.title;
      $("subtitle").innerText = T.subtitle;
      $("navHome").innerText = T.home;
      $("navRoadmap").innerText = T.roadmap;

      $("sourceLine").innerText = T.source;
      $("lblUsd").innerText = T.lblUsd;
      $("lblIbiti").innerText = T.lblIbiti;
      $("lblSlip").innerText = T.lblSlip;
      $("hint").innerText = T.hint;

      $("btnCalc").innerText = T.btnCalc;
      $("btnRefresh").innerText = T.btnRefresh;
      $("btnClear").innerText = T.btnClear;
      $("note").innerText = T.note;
    }

    // =========================
    // Price engine
    // =========================
    const state = {
      provider: null,
      price1e18: null,     // USDT per 1 IBITI * 1e18 (BigInt)
      reserves: null,      // {usdt, ibiti} BigInt
      updatedAt: 0
    };

    async function getProvider(){
      if (state.provider) return state.provider;

      let lastErr = null;
      for (const url of CFG.RPC_URLS){
        try{
          const p = new ethers.JsonRpcProvider(url);
          await p.getBlockNumber(); // ping
          state.provider = p;
          return p;
        }catch(e){
          lastErr = e;
        }
      }
      throw new Error(lastErr?.message || "No RPC available");
    }

    function formatSmart(numStr){
      const n = Number(numStr);
      if (!Number.isFinite(n)) return numStr;
      if (n >= 1) return n.toFixed(6);
      if (n >= 0.01) return n.toFixed(8);
      return n.toPrecision(8);
    }

    function timeStr(){
      return new Date().toLocaleString(lang === "ru" ? "ru-RU" : "en-US");
    }

    function setResult(text, ok=true){
      const el = $("result");
      el.className = "result " + (ok ? "ok" : "error");
      el.innerText = text || "";
    }

    function setTopUI(){
      if (!state.price1e18) return;

      const priceStr = ethers.formatUnits(state.price1e18, 18);
      $("pricePill").innerText = `${T.price}: $${formatSmart(priceStr)}`;
      $("updatedPill").innerText = `${T.updated}: ${timeStr()}`;

      if (state.reserves){
        const usdtStr  = ethers.formatUnits(state.reserves.usdt, CFG.USDT_DECIMALS);
        const ibitiStr = ethers.formatUnits(state.reserves.ibiti, CFG.IBITI_DECIMALS);
        $("reservesLine").innerText =
          `${T.reserves}: ${formatSmart(usdtStr)} USDT  |  ${formatSmart(ibitiStr)} IBITI`;
      }
    }

    async function fetchLivePrice(){
      const provider = await getProvider();
      const pair = new ethers.Contract(CFG.PAIR, PAIR_ABI, provider);

      const [t0, t1, reserves] = await Promise.all([
        pair.token0(),
        pair.token1(),
        pair.getReserves()
      ]);

      const token0 = t0.toLowerCase();
      const token1 = t1.toLowerCase();
      const r0 = BigInt(reserves[0]);
      const r1 = BigInt(reserves[1]);

      const usdt  = CFG.USDT.toLowerCase();
      const ibiti = CFG.IBITI.toLowerCase();

      let reserveUSDT, reserveIBITI;
      if (token0 === usdt && token1 === ibiti){
        reserveUSDT = r0; reserveIBITI = r1;
      } else if (token0 === ibiti && token1 === usdt){
        reserveUSDT = r1; reserveIBITI = r0;
      } else {
        throw new Error("PAIR tokens mismatch (not USDT/IBITI).");
      }

      if (reserveUSDT === 0n || reserveIBITI === 0n){
        throw new Error("Pair reserves are zero.");
      }

      // price1e18 = (USDT/IBITI) * 1e18
      // = reserveUSDT * 10^IBITI_DEC * 1e18 / (reserveIBITI * 10^USDT_DEC)
      const price1e18 =
        reserveUSDT *
        (10n ** BigInt(CFG.IBITI_DECIMALS)) *
        (10n ** 18n) /
        (reserveIBITI * (10n ** BigInt(CFG.USDT_DECIMALS)));

      state.price1e18 = price1e18;
      state.reserves = { usdt: reserveUSDT, ibiti: reserveIBITI };
      state.updatedAt = Date.now();

      setTopUI();
      return price1e18;
    }

    async function ensureFreshPrice(){
      if (state.price1e18 && (Date.now() - state.updatedAt) < 15000) return state.price1e18;
      return await fetchLivePrice();
    }

    function slippageBps(){
      const v = Number($("slippage").value);
      const pct = (Number.isFinite(v) && v >= 0) ? v : 0;
      return Math.round(pct * 100); // 1% = 100 bps
    }

    async function calc(){
      $("corsTip").innerText = "";
      const usd = Number($("usdInput").value || 0);
      const ibiti = Number($("ibitiInput").value || 0);

      if (usd > 0 && ibiti > 0){
        setResult(T.errOneField, false);
        return;
      }
      if (usd <= 0 && ibiti <= 0){
        setResult(T.errNeedValue, false);
        return;
      }

      setResult(T.working, true);
      const price1e18 = await ensureFreshPrice();

      const bps = slippageBps();
      const factor = BigInt(10000 - bps);

      if (usd > 0){
        const usdRaw = ethers.parseUnits(String(usd), CFG.USDT_DECIMALS);

        // tokensRaw = usd / price
        const tokensRaw =
          (usdRaw * (10n ** 18n) * (10n ** BigInt(CFG.IBITI_DECIMALS))) /
          ((10n ** BigInt(CFG.USDT_DECIMALS)) * price1e18);

        const minTokensRaw = (tokensRaw * factor) / 10000n;

        const tokens = ethers.formatUnits(tokensRaw, CFG.IBITI_DECIMALS);
        const minTokens = ethers.formatUnits(minTokensRaw, CFG.IBITI_DECIMALS);

        setResult(
          (lang === "ru")
            ? `≈ ${formatSmart(tokens)} IBITI\nМинимум (со слиппеджем): ≈ ${formatSmart(minTokens)} IBITI`
            : `≈ ${formatSmart(tokens)} IBITI\nMin (with slippage): ≈ ${formatSmart(minTokens)} IBITI`,
          true
        );
      } else {
        const ibitiRaw = ethers.parseUnits(String(ibiti), CFG.IBITI_DECIMALS);

        // usdRaw = ibiti * price
        const usdRaw =
          (ibitiRaw * price1e18 * (10n ** BigInt(CFG.USDT_DECIMALS))) /
          ((10n ** BigInt(CFG.IBITI_DECIMALS)) * (10n ** 18n));

        const minUsdRaw = (usdRaw * factor) / 10000n;

        const usdOut = ethers.formatUnits(usdRaw, CFG.USDT_DECIMALS);
        const minUsdOut = ethers.formatUnits(minUsdRaw, CFG.USDT_DECIMALS);

        setResult(
          (lang === "ru")
            ? `≈ $${formatSmart(usdOut)}\nМинимум (со слиппеджем): ≈ $${formatSmart(minUsdOut)}`
            : `≈ $${formatSmart(usdOut)}\nMin (with slippage): ≈ $${formatSmart(minUsdOut)}`,
          true
        );
      }
    }

    async function refresh(){
      $("corsTip").innerText = "";
      try{
        await fetchLivePrice();
        setResult(T.refreshed, true);
      }catch(e){
        console.error(e);
        setResult(`${T.fetchFail} ${e?.message || ""}`, false);
        $("corsTip").innerText = T.corsTip;
      }
    }

    function clearAll(){
      $("usdInput").value = "";
      $("ibitiInput").value = "";
      setResult("");
    }

    // =========================
    // Init
    // =========================
    applyI18n();

    $("btnCalc").addEventListener("click", () => calc().catch(err => {
      console.error(err);
      setResult(`${T.fetchFail} ${err?.message || ""}`, false);
      $("corsTip").innerText = T.corsTip;
    }));

    $("btnRefresh").addEventListener("click", refresh);
    $("btnClear").addEventListener("click", clearAll);

    // старт: обновить цену и дальше авто-апдейт
    refresh();
    setInterval(refresh, CFG.AUTO_REFRESH_MS);
  </script>

  <script src="js/xmas.js"></script>
</body>
</html>
