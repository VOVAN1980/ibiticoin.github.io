<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IBITI Receipt</title>

  <style>
    :root{
      --paper:#fff;
      --ink:#111;
      --muted:#666;
      --line:#e6e6e6;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    html, body{
      margin:0;
      padding:0;
      background:transparent;
      font-family:var(--sans);
      color:var(--ink);
    }

    body{
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
      padding:10px;
      box-sizing:border-box;
    }

    .receipt{
      width:min(560px, 100%);
      background:var(--paper);
      border:1px solid var(--line);
      border-radius:16px;
      box-shadow:0 18px 60px rgba(0,0,0,.22);
      overflow:hidden;
    }

    .head{
      padding:16px 18px;
      border-bottom:1px dashed #ddd;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }

    .title{font-weight:900; font-size:18px;}
    .sub{margin-top:4px; font-size:12px; color:var(--muted); line-height:1.35;}

    .pill{
      display:inline-block;
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      background:#111;
      color:#fff;
      font-weight:900;
      letter-spacing:.3px;
      margin-right:6px;
    }

    /* ✅ BIG MAINNET/TESTNET badge */
    .env{
      font-size:12px;
      padding:4px 10px;
      letter-spacing:.8px;
    }
    .env.testnet{ background:#111; }
    .env.mainnet{ background:#111; }

    .body{padding:14px 18px 14px;}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:10px 14px;}

    .row{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:7px 0;
      border-bottom:1px dotted #e6e6e6;
    }
    .row:last-child{border-bottom:0;}

    .k{color:var(--muted); font-size:12px;}
    .k small{
      display:block;
      margin-top:2px;
      font-size:10px;
      color:#888;
      font-weight:700;
      letter-spacing:.2px;
    }

    .v{
      font-family:var(--mono);
      font-size:12px;
      font-weight:800;
      text-align:right;
      word-break:break-all;
    }

    .sec{margin-top:12px; padding-top:10px; border-top:1px dashed #ddd;}
    .secTitle{font-size:12px; font-weight:900; letter-spacing:.6px; margin-bottom:8px;}

    .box{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:#fafafa;
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
      margin-top:8px;
    }
    .mono{font-family:var(--mono); font-size:11px; word-break:break-all;}

    .btn{
      border:1px solid #111;
      background:#111;
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
    }
    .btn.alt{
      background:#fff;
      color:#111;
      border-color:#ddd;
    }
    .btn.small{
      padding:7px 10px;
      font-size:12px;
      border-color:#ddd;
      background:#fff;
      color:#111;
    }

    .actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      margin-top:12px;
    }

    .foot{
      padding:12px 18px;
      border-top:1px dashed #ddd;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
    }
    .note{font-size:11px; color:var(--muted); line-height:1.35;}
    .err{color:#b00020; font-weight:900;}

    .stamp{
      width:86px;
      height:44px;
      border:2px solid #111;
      border-radius:10px;
      transform:rotate(-8deg);
      display:flex;
      align-items:center;
      justify-content:center;
      font-family:var(--mono);
      font-weight:900;
      letter-spacing:2px;
      position:relative;
      opacity:.95;
    }
    .stamp:before{
      content:"✓";
      position:absolute;
      left:10px;
      font-size:14px;
      letter-spacing:0;
    }
    .stamp span{
      padding-left:14px;
      font-size:14px;
    }

    @media print{
      body{padding:0;}
      .actions{display:none !important;}
      .receipt{
        box-shadow:none;
        border-radius:0;
        width:86mm;
        max-width:86mm;
        border:1px solid #000;
      }
    }
  </style>
</head>

<body>
  <div class="receipt" id="card">
    <div class="head">
      <div>
        <div class="title">IBITI Receipt</div>
        <div class="sub">
          Official transaction summary<br/>
          <span class="pill env" id="env">MAINNET</span>
          <span class="pill" id="status">LOADING</span>
        </div>
      </div>
      <div class="v" id="rid">—</div>
    </div>

    <div class="body">
      <div class="grid">
        <div class="row"><div class="k">Date</div><div class="v" id="date">—</div></div>
        <div class="row"><div class="k">Network</div><div class="v" id="network">—</div></div>
        <div class="row"><div class="k">Buyer</div><div class="v" id="buyer">—</div></div>
        <div class="row"><div class="k">Tx Hash</div><div class="v" id="txhash">—</div></div>
      </div>

      <div class="sec">
        <div class="secTitle">PURCHASE</div>

        <div class="row">
          <div class="k">Paid (USDT)<small>Approved: exact amount</small></div>
          <div class="v" id="paid">Pending…</div>
        </div>

        <div class="row"><div class="k">Market amount (IBITI)</div><div class="v" id="market">Pending…</div></div>
        <div class="row"><div class="k">Promo bonus (IBITI)</div><div class="v" id="bonus">Pending…</div></div>
        <div class="row"><div class="k">Total received (IBITI)</div><div class="v" id="total">Pending…</div></div>
        <div class="row"><div class="k">Effective price (USDT/IBITI)</div><div class="v" id="price">Pending…</div></div>
      </div>

      <div class="sec">
        <div class="secTitle">LINKS</div>

        <div class="box">
          <div class="mono" id="txLink">—</div>
          <button class="btn small" id="copyTx">Copy</button>
        </div>

        <div class="box">
          <div class="mono" id="refLink">—</div>
          <button class="btn small" id="copyRef">Copy</button>
        </div>

        <div class="actions">
          <button class="btn" id="saveImg">Save image</button>
          <button class="btn alt" id="print">Print</button>
          <button class="btn alt" id="close">Close</button>
        </div>

        <div id="error" class="note"></div>
      </div>
    </div>

    <div class="foot">
      <div class="note">
        Amounts are derived from on-chain Transfer logs.<br/>
        If bonus transfer is not separated, it is split by 10% rule.
      </div>
      <div class="stamp"><span>IBITI</span></div>
    </div>
  </div>

<script type="module">
  import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.13.5/+esm";
  import * as htmlToImage from "https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/+esm";

  const $ = (id) => document.getElementById(id);
  const qs = new URLSearchParams(location.search);

  const tx = (qs.get("tx") || "").trim();
  const buyer = (qs.get("buyer") || "").trim();
  const netKey = (qs.get("net") || "mainnet").toLowerCase();
  const paidHint = (qs.get("paid") || "").trim();

  const NETS = {
    mainnet: {
      name: "BNB Smart Chain",
      rpc: "https://bsc-dataseed.binance.org/",
      explorer: "https://bscscan.com",
      usdt: "0x55d398326f99059fF775485246999027B3197955",
      ibiti: "0x47F2FFCb164b2EeCCfb7eC436Dfb3637a457B9bb",
      ibitiDecDefault: 8,
      usdtDecDefault: 18
    },
    testnet: {
      name: "BNB Smart Chain Testnet",
      rpc: "https://data-seed-prebsc-1-s1.binance.org:8545/",
      explorer: "https://testnet.bscscan.com",
      usdt: "0xDC8eD79f9889F630Dc8083e5fD8C5294f1B603bb",
      ibiti: "0xc230f9394875305ac83013C0186a400865bc8f86",
      ibitiDecDefault: 8,
      usdtDecDefault: 18
    }
  };

  const net = NETS[netKey] || NETS.mainnet;

  function setStatus(s){ $("status").textContent = s; }
  function setErr(s){ $("error").innerHTML = s ? `<span class="err">${s}</span>` : ""; }

  // ✅ MAINNET/TESTNET big badge
  const env = $("env");
  if (env) {
    const isTest = netKey === "testnet";
    env.textContent = isTest ? "TESTNET" : "MAINNET";
    env.classList.toggle("testnet", isTest);
    env.classList.toggle("mainnet", !isTest);
  }

  function fmtDate(tsSec){
    const d = new Date(Number(tsSec) * 1000);
    const pad = (n)=>String(n).padStart(2,"0");
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  const TRANSFER_TOPIC = ethers.id("Transfer(address,address,uint256)");
  function topicToAddr(topic){
    if(!topic || topic.length < 66) return null;
    return ethers.getAddress("0x" + topic.slice(-40));
  }

  function smartTrim(s, maxFrac=8){
    s = String(s ?? "");
    if(!s.includes(".")) return s;
    const [a,b] = s.split(".");
    const bb = (b || "").slice(0, maxFrac).replace(/0+$/,"");
    return bb ? `${a}.${bb}` : a;
  }

  function split10(total){
    const base = (total * 100n) / 110n; // floor => 1 satoshi difference possible
    const bonus = total - base;
    return { base, bonus, total };
  }

  function buildReferralLink(buyerAddr){
    const u = new URL(location.origin + "/shop.html");
    if (netKey === "testnet") u.searchParams.set("net","testnet");
    if (buyerAddr) u.searchParams.set("ref", buyerAddr);
    return u.toString();
  }

  function buildTxLink(hash){
    return `${net.explorer}/tx/${hash}`;
  }

  async function getDecimals(provider, token, fallback){
    try{
      const erc20 = new ethers.Contract(token, ["function decimals() view returns (uint8)"], provider);
      return Number(await erc20.decimals());
    }catch(_){
      return fallback;
    }
  }

  async function pollReceipt(provider, hash, ms=120000){
    const t0 = Date.now();
    while(Date.now() - t0 < ms){
      const r = await provider.getTransactionReceipt(hash);
      if (r) return r;
      await new Promise(res=>setTimeout(res, 2000));
    }
    return null;
  }

  async function decodeAmounts(receipt, buyerAddr, usdtAddr, ibitiAddr, usdtDec, ibitiDec){
    const b = buyerAddr.toLowerCase();
    const u = usdtAddr.toLowerCase();
    const i = ibitiAddr.toLowerCase();

    let paid = 0n;
    const ibitiIn = [];

    for(const log of receipt.logs || []){
      const addr = String(log.address || "").toLowerCase();
      if (!log.topics || log.topics.length < 3) continue;
      if (String(log.topics[0]).toLowerCase() !== TRANSFER_TOPIC.toLowerCase()) continue;

      const from = topicToAddr(log.topics[1])?.toLowerCase();
      const to = topicToAddr(log.topics[2])?.toLowerCase();
      const val = BigInt(log.data);

      if (addr === u && from === b) paid += val;
      if (addr === i && to === b) ibitiIn.push(val);
    }

    ibitiIn.sort((a,b)=> (a>b ? -1 : a<b ? 1 : 0));
    let market = 0n, bonus = 0n, total = 0n;

    if (ibitiIn.length >= 2){
      market = ibitiIn[0];
      bonus = ibitiIn.slice(1).reduce((s,v)=>s+v,0n);
      total = market + bonus;
    } else if (ibitiIn.length === 1){
      total = ibitiIn[0];
      const sp = split10(total);
      market = sp.base;
      bonus = sp.bonus;
    }

    const paidStr = smartTrim(ethers.formatUnits(paid, usdtDec), 6);
    const marketStr = smartTrim(ethers.formatUnits(market, ibitiDec), 8);
    const bonusStr = smartTrim(ethers.formatUnits(bonus, ibitiDec), 8);
    const totalStr = smartTrim(ethers.formatUnits(total, ibitiDec), 8);

    let priceStr = "—";
    try{
      if (market > 0n){
        const scaled = (paid * 100000000n) / market; // 8-dec fixed
        priceStr = smartTrim(ethers.formatUnits(scaled, 8), 10);
      }
    }catch(_){}

    return { paidStr, marketStr, bonusStr, totalStr, priceStr };
  }

  // UI init
  $("network").textContent = net.name + (netKey==="testnet" ? " (testnet)" : "");
  $("buyer").textContent = buyer || "—";
  $("txhash").textContent = tx || "—";
  $("rid").textContent = tx ? ("IBITI-" + tx.slice(2,10).toUpperCase()) : "—";

  const txUrl = tx ? buildTxLink(tx) : "—";
  $("txLink").textContent = txUrl;
  $("refLink").textContent = buildReferralLink(buyer);

  $("copyTx").onclick = async ()=>{ try{ await navigator.clipboard.writeText(txUrl); }catch(_){} };
  $("copyRef").onclick = async ()=>{ try{ await navigator.clipboard.writeText($("refLink").textContent); }catch(_){} };

  $("close").onclick = ()=> {
    try {
      if (window.parent && window.parent.closeReceiptModal) return window.parent.closeReceiptModal();
    } catch(_) {}
    try { window.close(); } catch(_) { location.href="/shop.html"; }
  };

  $("print").onclick = ()=> window.print();

  // ✅ Save image: NEVER print. If download blocked → open image tab.
  $("saveImg").onclick = async ()=> {
    try{
      const node = $("card");
      const dataUrl = await htmlToImage.toPng(node, {
        cacheBust: true,
        pixelRatio: 2,
        backgroundColor: "#ffffff"
      });

      const rid = ($("rid")?.textContent || "IBITI-RECEIPT").replace(/[^a-zA-Z0-9-_]/g,"");
      const filename = `${rid}.png`;

      // try download
      try{
        const a = document.createElement("a");
        a.href = dataUrl;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        return;
      } catch(_) {}

      // fallback: open image in new tab (mobile save)
      window.open(dataUrl, "_blank", "noopener,noreferrer");
      setErr("Opened image in a new tab. Long-press to save on mobile.");
    }catch(e){
      setErr("Save image failed in this browser. Use screenshot or Print.");
    }
  };

  if (paidHint) $("paid").textContent = paidHint;

  if (!tx || !/^0x[0-9a-fA-F]{64}$/.test(tx)) {
    setStatus("ERROR");
    setErr("Missing or invalid tx hash in URL (?tx=0x...)");
    throw new Error("bad tx");
  }

  setStatus("PENDING");
  const provider = new ethers.JsonRpcProvider(net.rpc);

  const usdtDec = await getDecimals(provider, net.usdt, net.usdtDecDefault);
  const ibitiDec = await getDecimals(provider, net.ibiti, net.ibitiDecDefault);

  const receipt = await pollReceipt(provider, tx, 120000);
  if (!receipt) {
    setStatus("PENDING");
    setErr("Transaction is not confirmed yet. Refresh this page in a moment.");
  } else {
    setStatus("DONE");
    try{
      const blk = await provider.getBlock(receipt.blockNumber);
      if (blk?.timestamp) $("date").textContent = fmtDate(blk.timestamp);
    }catch(_){}

    try{
      const amounts = await decodeAmounts(
        receipt,
        (buyer||"0x0000000000000000000000000000000000000000"),
        net.usdt, net.ibiti,
        usdtDec, ibitiDec
      );
      $("paid").textContent = amounts.paidStr;
      $("market").textContent = amounts.marketStr;
      $("bonus").textContent = amounts.bonusStr;
      $("total").textContent = amounts.totalStr;
      $("price").textContent = amounts.priceStr;
    }catch(_){
      setErr("Receipt loaded, but amounts decoding failed.");
    }
  }
</script>
</body>
</html>
