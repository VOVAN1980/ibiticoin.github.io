<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IBITI Receipt</title>

  <style>
    :root{
      --paper:#fff;
      --ink:#111;
      --muted:#666;
      --line:#e6e6e6;
      --accent:#111;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* overlay (экран) */
    .ibiti-overlay{
      position: fixed; inset: 0;
      display:none;
      background: rgba(0,0,0,.55);
      align-items: center; justify-content: center;
      padding: 16px;
      z-index: 999999;
    }
    .ibiti-overlay.ibiti-open{ display:flex; }

    /* paper card */
    .ibiti-card{
      width: min(520px, 100%);
      background: var(--paper);
      color: var(--ink);
      border: 1px solid var(--line);
      border-radius: 14px;
      box-shadow: 0 16px 60px rgba(0,0,0,.35);
      overflow: hidden;
    }

    .ibiti-head{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
      padding: 18px 18px 10px;
      border-bottom: 1px solid var(--line);
    }
    .ibiti-title{
      line-height: 1.2;
    }
    .ibiti-title b{
      font-family: var(--sans);
      font-size: 18px;
      letter-spacing: .2px;
    }
    .ibiti-title div{
      margin-top: 3px;
      font-family: var(--sans);
      font-size: 12px;
      color: var(--muted);
    }
    .ibiti-x{
      border:0;
      background: transparent;
      font-size: 22px;
      line-height: 1;
      cursor:pointer;
      color: #222;
      padding: 2px 6px;
    }

    .ibiti-body{
      padding: 14px 18px 16px;
      font-family: var(--sans);
      font-size: 13px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 14px;
      margin-bottom: 12px;
    }

    .row{
      display:flex;
      justify-content: space-between;
      gap: 12px;
      padding: 7px 0;
      border-bottom: 1px dashed #ddd;
      font-family: var(--sans);
    }
    .row:last-child{ border-bottom: 0; }

    .k{ color: var(--muted); }
    .v{
      font-family: var(--mono);
      color: var(--ink);
      text-align: right;
      word-break: break-all;
    }

    .section-title{
      margin: 12px 0 6px;
      font-weight: 700;
      font-size: 12px;
      letter-spacing: .3px;
      text-transform: uppercase;
      color: #222;
      font-family: var(--sans);
    }

    .txline{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 8px 0 6px;
      border-bottom: 1px solid var(--line);
    }
    .txline a{
      font-family: var(--mono);
      font-size: 12px;
      color: #111;
      text-decoration: underline;
      word-break: break-all;
    }

    .actions{
      display:flex;
      gap: 10px;
      padding: 14px 18px 18px;
      border-top: 1px solid var(--line);
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .btn{
      border: 1px solid #111;
      background: #111;
      color: #fff;
      font-family: var(--sans);
      padding: 10px 12px;
      border-radius: 10px;
      cursor:pointer;
      font-size: 13px;
    }
    .btn.secondary{
      background:#fff;
      color:#111;
    }

    .fineprint{
      margin-top: 10px;
      font-size: 11px;
      color: var(--muted);
      font-family: var(--sans);
      line-height: 1.35;
    }

    /* stamp */
    .stamp-wrap{
      position: relative;
      height: 90px;
      margin-top: 12px;
    }
    .stamp{
      position:absolute;
      right: 0;
      bottom: 0;
      width: 92px;
      height: 92px;
      transform: rotate(-12deg);
      opacity: .9;
      pointer-events:none;
    }
    .stamp svg{ width:100%; height:100%; display:block; }

    /* ===== PRINT: чистый чек на белом ===== */
    @media print{
      html,body{
        background:#fff !important;
        color:#000 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .ibiti-overlay{
        position: static;
        inset: auto;
        background: transparent !important;
        padding: 0 !important;
        display: block !important;
      }
      .ibiti-card{
        box-shadow: none !important;
        border: 1px solid #000 !important;
        border-radius: 0 !important;
        width: 100% !important;
        max-width: 86mm;  /* чек “как в магазине” */
        margin: 0 auto;
      }
      .actions, .ibiti-x{ display:none !important; }
      .ibiti-body{ font-size: 12px !important; }
      .ibiti-title b{ font-size: 16px !important; }
      .txline a{ text-decoration: none; }
    }

    /* helper */
    .ibiti-hidden{ display:none !important; }
  </style>
</head>

<body>
  <div id="ibitiOverlay" class="ibiti-overlay">
    <div id="receiptCard" class="ibiti-card" role="dialog" aria-modal="true">
      <div class="ibiti-head">
        <div class="ibiti-title">
          <b>IBITI Receipt</b>
          <div>Official transaction summary</div>
        </div>
        <button class="ibiti-x" aria-label="Close" id="btnClose">×</button>
      </div>

      <div class="ibiti-body">
        <div class="grid">
          <div class="row"><div class="k">Date</div><div class="v" id="rDate">—</div></div>
          <div class="row"><div class="k">Network</div><div class="v" id="rNet">—</div></div>
          <div class="row"><div class="k">Buyer</div><div class="v" id="rBuyer">—</div></div>
          <div class="row"><div class="k">Receipt ID</div><div class="v" id="rId">—</div></div>
        </div>

        <div class="section-title">Purchase</div>
        <div class="row"><div class="k">Paid (USDT)</div><div class="v" id="rPaid">—</div></div>
        <div class="row"><div class="k">Market amount (IBITI)</div><div class="v" id="rBase">—</div></div>
        <div class="row"><div class="k">Promo bonus (IBITI)</div><div class="v" id="rBonus">—</div></div>
        <div class="row"><div class="k"><b>Total received (IBITI)</b></div><div class="v" id="rTotal"><b>—</b></div></div>
        <div class="row"><div class="k">Effective price (USDT / IBITI)</div><div class="v" id="rPrice">—</div></div>

        <div class="section-title">Transaction</div>
        <div class="txline">
          <a id="rTxLink" href="#" target="_blank" rel="noreferrer">—</a>
          <button class="btn secondary" id="btnCopyTx">Copy</button>
        </div>

        <div class="section-title">Referral link</div>
        <div class="txline">
          <a id="rRefLink" href="#" target="_blank" rel="noreferrer">—</a>
          <button class="btn secondary" id="btnCopyRef">Copy</button>
        </div>

        <div class="stamp-wrap">
          <div class="stamp" aria-hidden="true">
            <svg viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="46" fill="none" stroke="#111" stroke-width="3"/>
              <circle cx="50" cy="50" r="36" fill="none" stroke="#111" stroke-width="1.8" stroke-dasharray="3 3"/>
              <text x="50" y="54" text-anchor="middle" font-family="ui-monospace, monospace" font-size="18" fill="#111" font-weight="700">IBITI</text>
              <text x="50" y="70" text-anchor="middle" font-family="ui-monospace, monospace" font-size="8.5" fill="#111">OFFICIAL</text>
            </svg>
          </div>
        </div>

        <div class="fineprint">
          Base amount is the executed on-chain swap result. Promo bonus is added on top.<br>
          If MetaMask RPC is moody, receipt is loaded via public RPC.
        </div>
      </div>

      <div class="actions">
        <button class="btn secondary" id="btnPng">Download PNG</button>
        <button class="btn" id="btnPrint">Print / Save PDF</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      // === helpers ===
      const $ = (id) => document.getElementById(id);
      const overlay = $("ibitiOverlay");

      function net(){
        try { return window.IBITI_CONFIG && window.IBITI_CONFIG.getNet ? window.IBITI_CONFIG.getNet() : null; }
        catch(_){ return null; }
      }

      function explorerTxLink(txHash){
        const n = net();
        const base = (n && n.blockExplorerUrls && n.blockExplorerUrls[0]) ? n.blockExplorerUrls[0] : "https://bscscan.com";
        return base.replace(/\/+$/,"") + "/tx/" + txHash;
      }

      function buildReferralLink(buyer){
        const u = new URL(window.location.href);
        u.pathname = "/shop.html";
        const sp = u.searchParams;
        sp.set("ref", buyer);
        u.search = sp.toString();
        return u.toString();
      }

      function setText(id, txt){ const el = $(id); if (el) el.textContent = (txt ?? "—"); }
      function safeNum(n){ return Number.isFinite(n) ? n : 0; }

      // === modal control ===
      function open(){ overlay.classList.add("ibiti-open"); }
      function close(){ overlay.classList.remove("ibiti-open"); }

      $("btnClose").addEventListener("click", close);
      overlay.addEventListener("click", (e)=>{ if(e.target === overlay) close(); });

      // === copy buttons ===
      $("btnCopyTx").addEventListener("click", async ()=>{
        const a = $("rTxLink");
        const txUrl = a && a.href ? a.href : "";
        if (!txUrl) return;
        try { await navigator.clipboard.writeText(txUrl); } catch(_){}
      });

      $("btnCopyRef").addEventListener("click", async ()=>{
        const a = $("rRefLink");
        const refUrl = a && a.href ? a.href : "";
        if (!refUrl || refUrl === "#") return;
        try { await navigator.clipboard.writeText(refUrl); } catch(_){}
      });

      // === html2canvas loader for PNG ===
      let _h2cPromise = null;
      async function ensureHtml2Canvas(){
        if (window.html2canvas) return true;
        if (_h2cPromise) return _h2cPromise;

        _h2cPromise = new Promise((resolve) => {
          const s = document.createElement("script");
          s.src = "https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js";
          s.onload = () => resolve(true);
          s.onerror = () => resolve(false);
          document.head.appendChild(s);
        });
        return _h2cPromise;
      }

      async function downloadPng(){
        const card = $("receiptCard");
        const ok = await ensureHtml2Canvas();
        if (!ok || !window.html2canvas || !card) return;

        // рендерим как белую бумагу
        const scale = Math.max(2, Math.ceil((window.devicePixelRatio || 1) * 1.6));
        const canvas = await window.html2canvas(card, { scale, backgroundColor:"#ffffff", useCORS:true });
        const url = canvas.toDataURL("image/png");

        const a = document.createElement("a");
        a.href = url;
        a.download = `IBITI_Receipt_${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      $("btnPng").addEventListener("click", downloadPng);

      // === Print: отдельное окно, без overlay и без багов масштаба ===
      function printReceipt(){
        const card = $("receiptCard");
        if (!card) return;

        const w = window.open("", "_blank", "width=480,height=720");
        if (!w) return;

        const css = Array.from(document.styleSheets)
          .map(s => { try { return Array.from(s.cssRules).map(r=>r.cssText).join("\n"); } catch(_){ return ""; } })
          .join("\n");

        w.document.open();
        w.document.write(`
<!doctype html>
<html><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>IBITI Receipt</title>
<style>${css}</style>
</head>
<body>
<div class="ibiti-overlay ibiti-open" style="background:transparent;padding:0;">
  ${card.outerHTML}
</div>
<script>
  // убрать кнопки/крестик на всякий
  const x = document.getElementById("btnClose"); if (x) x.remove();
  const acts = document.querySelector(".actions"); if (acts) acts.remove();
  window.onload = () => { window.print(); };
</script>
</body></html>`);
        w.document.close();
      }

      $("btnPrint").addEventListener("click", printReceipt);

      // === декод события покупки ===
      async function decodePromoBuy({receipt, promoRouter}){
        const ethers = window.ethers;
        if(!ethers || !receipt || !receipt.logs) return null;

        const iface = new ethers.Interface([
          "event PromoBuy(address indexed buyer,address indexed referrer,uint256 paymentAmount,uint256 boughtAmount,uint256 bonusAmount,uint256 refAmount)"
        ]);
        const topic0 = iface.getEvent("PromoBuy").topicHash;

        const pr = promoRouter ? String(promoRouter).toLowerCase() : null;
        let log = receipt.logs.find(l => l?.topics?.[0] === topic0 && (!pr || String(l.address).toLowerCase() === pr));
        if(!log) log = receipt.logs.find(l => l?.topics?.[0] === topic0);
        if(!log) return null;

        const ev = iface.decodeEventLog("PromoBuy", log.data, log.topics);
        return {
          buyer: ev.buyer,
          referrer: ev.referrer,
          paymentAmount: ev.paymentAmount,
          boughtAmount: ev.boughtAmount,
          bonusAmount: ev.bonusAmount,
          refAmount: ev.refAmount
        };
      }

      function setBaseUI({buyer, txHash, netName, receiptId}){
        const dt = new Date();
        setText("rDate", dt.toLocaleString());
        setText("rBuyer", buyer || "—");
        setText("rNet", netName || "—");
        setText("rId", receiptId || "—");

        // tx link
        const tx = (txHash || "—");
        const txUrl = txHash ? explorerTxLink(txHash) : "#";
        const aTx = $("rTxLink");
        aTx.textContent = tx;
        aTx.href = txUrl;

        // referral
        const refA = $("rRefLink");
        if (buyer && buyer !== "—") {
          const url = buildReferralLink(buyer);
          refA.textContent = url;
          refA.href = url;
        } else {
          refA.textContent = "—";
          refA.href = "#";
        }
      }

      async function showFromReceipt({ receipt, txHash, buyer, usdtDecimals }){
        const n = net() || {};
        const promoRouter =
          n.promoRouter || n.promo || n.PROMO_ROUTER || n.promoRouterAddress || null;

        const netName = (n.key === "testnet" || n.chainId == 97)
          ? "BNB Smart Chain Testnet"
          : "BNB Smart Chain";

        open();
        const rid = "IBITI-" + (txHash ? txHash.slice(2,10).toUpperCase() : (receipt?.hash ? receipt.hash.slice(2,10).toUpperCase() : "—"));
        setBaseUI({ buyer, txHash: txHash || receipt?.hash, netName, receiptId: rid });

        // default
        setText("rPaid", "—");
        setText("rBase", "—");
        setText("rBonus", "—");
        setText("rTotal", "—");
        setText("rPrice", "—");

        if(!receipt){
          setText("rPaid", "Pending…");
          setText("rBase", "Pending…");
          setText("rBonus", "Pending…");
          setText("rTotal", "Pending…");
          setText("rPrice", "Pending…");
          return;
        }

        const ev = await decodePromoBuy({ receipt, promoRouter });
        if(!ev) return;

        const usDec = Number(usdtDecimals || 18);
        const ibDec = 8; // IBITI fixed
        const paid  = Number(ev.paymentAmount) / Math.pow(10, usDec);
        const base  = Number(ev.boughtAmount)   / Math.pow(10, ibDec);
        const bonus = Number(ev.bonusAmount)    / Math.pow(10, ibDec);
        const total = base + bonus;

        const price = total > 0 ? (paid / total) : 0;

        setText("rPaid",  safeNum(paid).toFixed(2) + " USDT");
        setText("rBase",  safeNum(base).toFixed(4) + " IBITI");
        setText("rBonus", safeNum(bonus).toFixed(4) + " IBITI");
        setText("rTotal", safeNum(total).toFixed(4) + " IBITI");
        setText("rPrice", safeNum(price).toFixed(8));
      }

      async function showFromTxHash({ txHash, buyer, usdtDecimals }){
        // “pending” версия: покажем сразу, чтобы пользователь не психовал
        await showFromReceipt({ receipt: null, txHash, buyer, usdtDecimals });
      }

      // expose API
      window.IBITI_RECEIPT = {
        ready: true,
        open,
        close,
        showFromReceipt,
        showFromTxHash
      };
    })();
  </script>
</body>
</html>
